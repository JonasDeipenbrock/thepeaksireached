version: 2.1

orbs:
    node: circleci/node@5.0.3

jobs:
    deploy-preview:
        docker:
            - image: cimg/node:18.10.0
        steps:
            - checkout
            - run: echo "hello world"
    build:
        docker:
            - image: node:18
        resource_class: large
        parallelism: 10

        steps:
            - checkout
            - restore_cache:
                  name: Restore pnpm Package Cache
                  keys:
                      - pnpm-packages-{{ checksum "pnpm-lock.yaml" }}
            - run:
                  name: Install pnpm package manager
                  command: |
                      curl -L https://pnpm.js.org/pnpm.js | node - add --global pnpm@7
            - run:
                  name: Install Dependencies
                  command: |
                      pnpm install
            - save_cache:
                  name: Save pnpm Package Cache
                  key: pnpm-packages-{{ checksum "pnpm-lock.yaml" }}
                  paths:
                      - node_modules
            - run:
                  name: Build project
                  command: |
                      pnpm build

workflows:
    preview:
        triggers:
            - schedule:
                  cron: '0 0 * * *'
                  filters:
                      branches:
                          ignore:
                              - main
        jobs:
            - deploy-preview
    deploy:
        jobs:
            - build
